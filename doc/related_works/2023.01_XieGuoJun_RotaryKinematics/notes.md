# 摘要
  机器人的运动安全很重要。
  传统的软硬件设计依靠经验和测试来保证安全性，未能覆盖所有路径；形式化可为机器人运动安全提供可靠的保证。
  为了证明此方法的可行性，在Coq中对机器人刚体运动学的数学坐标变换形式化，以验证其理论设计的正确性。
  首先，基于记录类型矩阵，构造Frobenius范数（所有元素的平方和再开方）、迹、内积；
  然后，按约定角度的旋转矩阵（roll-pitch-yaw，欧拉）的验证，以及罗德里格斯公式的验证，
  本文的形式化有多种基本应用，为机器人控制系统验证提供了一个可泛化的运动学分析框架。
  此外，为自动编程能力提供了条件。

# 介绍
  机器人的安全性验证的重要性。
  
  本文重点是机器人旋转运动学的形式化验证。
  旋转运动学是运动学几何的应用，描述的是纯几何问题（机器人的位置和方位）。
  因此，机器人运动控制运动学描述，并可以在数学上验证。
  目标是，使用Coq形式化的验证机器人运动学的旋转问题。
  
  在机器人系统中，连杆和机械手被看做刚体，向量-矩阵理论可用来建立它们相对于全局坐标系的位置和运动的描述。
  用 G 来表示全局坐标系，用 B 表示局部坐标系，用 ${}^BR_G$表示向量r从G转换到B。
  【这里，更准确的是，在B参考系下的坐标转换到G参考系下的坐标】
  通过这两个矩阵，可以定义连杆之间以及连杆和全局之间的位置。
  
  形式化验证依赖于数学建模和演绎推理，比经验更加严格和可靠。
  通过对机器人旋转运动学进行形式验证，希望保证机器人控制及其算法按设计的安全性。
  形式化框架如图：矩阵形式化 ==> 旋转运动 rotation、整转运动（公转）revolution ==> Rodriguez, Euler angles，
  
  贡献：
  扩展了矩阵库（F范数、迹、内积）。
  旋转运动分为 rotation 和 revolution，对系统坐标变换进行了完整验证。
  构造了角度旋转矩阵，以给提供欧拉角的形式定义和验证。
  提供了罗德里格斯公式的定义和验证。
  通过对机器人旋转运动问题的案例分析，论证了所提出的形式化方法的适用性，
  并演示了如何形式验证具体的机器人旋转问题。
  
  文章组织：
  第2节，相关工作
  第3节，回顾了矩阵形式化和旋转运动学。
  第4节，提出了形式化的空间几何验证方法。
  第5节，形式化定义了rotation和revolution，并验证了相关性质。
  第6，7，分别验证了欧拉角和罗德里格斯公式。
  第8节，案例分析，并验证旋转运动学的正确性。
  第9节，总结

# 2. 相关工作
  机器人验证领域，今年提出了许多方法。
  许多研究人员已经将形式化验证应用于各种真实世界的机器人应用。
  
  工业领域，
  
  医疗保健领域。
  
  无人机和自动驾驶
  
  与上述研究不同，我们关注旋转运动学问题，并使用Coq形式验证机器人旋转运动学。
  
# 3. 预备
  * 3.1 基于记录的矩阵
  * 3.2 旋转运动学
    研究全局坐标系G和局部坐标系B之间的关系。
	
	对于B中的刚体D，初始时B和G重合。
	用O表示坐标系原点。
	D绕G的的运动是revolution。
	在这个运动中，刚体D相对于B是静止的。
	因此，从O到D上的任意一点P的向量r，其在G和B中的等价关系为以下公式。
	[1] G_r = Q * B_r
	其中，{G_r,B_r是r在B和G中的坐标表示}，Q是 revolution 矩阵。
	
	对于G中的刚体D，D绕B的运动是 rotation。
	在这个运动中，刚体D在G中是静止的。
	此时，O到D上任意点P的向量r，其关系如下。
	[2] B_r = A * G_r
	其中，A是 rotation 矩阵。

# 4. 空间几何的形式化
  * 4.1 trace
	定义：对角线元素之和。
  * 4.2 F范数
	定义：所有元素的平方和再开方。
    记号：|m| = (Frobenius m)
    通过F的定义，可以验证空间矩阵的性质
	引理1：|mat0| = 0
	引理2：|mat1| = sqrt n
	【注意，后文中的单位向量，就是F范数为1的向量】
  * 4.3 矩阵内积
    定义：两个同型矩阵的对应元素乘积之和。
	记号：ma . mb = (Dot_Product ma mb)
	引理3：ma.mb = mb.ma
	引理4：(k*ma).mb = k*(ma.mb)
	引理5：(ma+mb).mc = ma.mc + mb.mc
  * 4.4 向量
    定义：R_vector := Mat R n 1.
	记号：向量之间的角度 <<v1,v2>>
	引理6： v1.v2 = |v1| * |v2| * cos(<<v1,v2>>)
	【疑问，角度是如何定义定义？不应该是从内积来定义吗】
# 5. 旋转运动学的形式化
  * 5.1 全局和局部坐标系
    归纳定义 RAG = X | Y | Z 表示全局坐标系的三个轴 (Rotation Axis Global)
	
	归纳定义 RAB = x | y | z 表示局部坐标系的三个轴 ( ... local (body) *)
	
	图2展示了两个坐标系。
	任给向量r，G_r 和 B_r 分别是r在G和B中的表示。
	而且，X_1,Y_1,Z_1是r在G中的坐标，x_1,y_z,z_1是r在G中的坐标。
	因此，r在G和B中可按如下公式来表示
	[7]
	G_r = X_1 * I + Y_1 * J + Z_1 * K
	B_r = x_1 * i + y_1 * j + z_1 * k
	其中，I,J,K是G的方向向量，i,j,k是B的方向向量(direction vector)
	【方向向量：空间直线的方向用一个与该直线平行的非零向量来表示，该向量称为这条直线的一个方向向量。
	直线在空间中的位置，由它经过的空间一点及它的一个方向向量完全确定】
	【这里用“方向向量”不合适，因为需要是单位的，所以应该是坐标轴的单位向量】
	
	将上述公式写成定义
	Definition G_r X_1 Y_1 Z_1 = ...。其中，I,J,K应该是单位向量。
	
	然后，使用公理 axiom1,axiom2 描述r在G和B中的的关系：
	axiom1: X_1 = B_r . I /\ Y_1 = B_r . J /\ Z_1 = B_r . K
	axiom1: x_1 = G_r . i /\ y_1 = G_r * j /\ z_1 = G_r . k
	其中，B_r * I 的几何含义是：B_r 在 I上的投影长度。
  * 5.2 Rotary运动的形式化
    * 5.2.1 Revolution运动的形式化
	  根据公式[1]，revolution矩阵Q如下
	  Q = [[i.I; j.I; k.I]; ...]
	  其中，I,J,K,i,j,k都是单位向量。
	  Q的列向量表示了B和G的每个坐标轴之间的角度的余弦。
	  基于这个定义，可以验证公式[1]
	  
	  定理1：G_r = Q * B_r 
	  【并未交代如何证明？】
	  说明：按照RAG的定义，分为三种情形（绕三个轴单独旋转），
	  在图3中，比如，刚体D绕G的X轴旋转。
	  根据图3，定义了相应的 revolution 矩阵如下：
	  QX = [[1;0;0];[0; cos; -sin];[0;sin;cos]].
	  QY = 
	  QZ = 
	  【这里的定义没有交代为什么是这样】
	  
	  使用如下定理来验证Q和 QX/QY/QZ 的等价
	  
	  定理2：当B绕G的X轴旋转theta时，Q = (QX theta)
	  定理3：当B绕G的X轴旋转theta时，G_r = (QX theta) * B_r
	  定理4：绕Y
	  定理5：
	  定理6：绕Z
	  定理7：
	  
	  当B进行了有限次的绕RAG的连续 revolutons Q1,Q2,...,Qn 后，r在G和B中的等价关系如下
	  [8] G_r = (Q_n * ... *(Q_2 * (Q1 * B_r)))
	  
	  因此，递归的用CRG (表示连续的RG) 来定义公式[8]。
	  使用 rl : list (RAG * R) 来表示旋转轴和角度。
	  
	  【解释了递归函数CRG的定义】
	  
	  将有限的连续的绕RAG的revolution合成到绕一条直线的一个revolution。
	  合成的 revolution 矩阵是全局revolution矩阵 GQB
	  [9] GQB = Q_n * ... * Q_2 * Q_1
	  【定义与 CRG 类似，只是用mat1来表示初始的旋转矩阵 】
	  
	  基于这些定义，验证了公式[9]
	  引理7：任意旋转序列 rl = [Q_1; ...; Q_n]，B中的初始位置r，则
		  (Q_n * ... * (Q_2 * (Q_1 * r))) = (Q_n * ... * Q_2 * Q_1) * r
    * 5.2.2 Rotation运动的形式化
	  与定义 revolution 矩阵Q类似，按照公式[2]，定义rotation矩阵A
	  A = [[I.i; J.i; K.i]; ...]
	  相应的，形式化验证公式[2]
	  定理8：B_r = A * G_r
	  
	  图4显示了RAB的三种情形。
	  相应的定义
	  Ax = [[1;0;0];[0;cos;sin];[0;-sin;cos]]
	  Ay =
	  Az =
	  
	  使用如下定理来验证A和 Ax/Ay/Az 的等价
	  
	  定理9：当D绕B的x轴旋转theta时，A = (Ax theta)
	  定理10：当D绕B的x轴旋转theta时，B_r = (Ax theta) * G_r
	  定理11：绕y
	  定理12：
	  定理13：绕z
	  定理14：
	  
	  当D进行了有限次的绕RAB的连续 rotations A1,A2,...,An 后，r在B和G中的等价关系如下
	  [10] B_r = (A_n * ... *(A_2 * (A1 * G_r)))
	  
	  因此，递归的用CRB (表示连续的RB) 来定义公式[10]。
	  使用 rl : list (RAB * R) 来表示旋转轴和角度。
	  
	  【解释了递归函数CRB的定义】
	  
	  将有限的连续的绕RAB的rotation合成到绕一条直线的一个rotation。
	  合成的 rotation 矩阵是局部 rotation 矩阵 BAG
	  [11] BAG = A_n * ... * A_2 * A_1
	  
	  基于这些定义，验证了公式[11]
	  引理8：任意旋转序列 rl = [A_1; ...; A_n]，G中的初始位置r，则
		  (A_n * ... * (A_2 * (A_1 * r))) = (A_n * ... * A_2 * A_1) * r
    * 5.2.3 GAB和GQB的关系
	  根据公式[9] 和[11]，BAG和GQB的关系按如下公式给出
	  [12]
	  B_r = BAG * GQB * B_r
	  G_r = GQB * BAG * G_r
	  对于公式[12]，使用引理9和10来证明 GQB和BAG的逆。
	  
	  引理9：任意非零向量r，GQB是B到G的revolution矩阵，BAG是G到B的rotation矩阵，那么 BAG*GQB=I
	  引理10：任意非零向量r，GQB是B到G的revolution矩阵，BAG是G到B的rotation矩阵，那么 GQB*BAG=I
	  
	  类似于证明 GQB和BAG的逆，也验证了 GQB和GAG的转置。
	  其中，rev 是列表的翻转，trans是矩阵的翻转。
	  
	  引理11：GQB是B到G的revolution矩阵，BAG是G到B的rotation矩阵，那么 GQB=(BAG)\T
	  【这里使用了两个参数，或许不需要这样】
	  引理12：GQB是B到G的revolution矩阵，BAG是G到B的rotation矩阵，那么 BAG=(GQB)\T
	  【根据转置的性质，这个引理是平凡的】
# 6. 欧拉角
  在3D空间中，任何坐标系的朝向都能用欧拉角表示。
  全局坐标系假定是静止的，局部坐标系与刚体一起运动。
  欧拉角用三个独立的参数来描述，决定了顶点旋转刚体的位置，通过 precession, nutation, rotation。
  图5是欧拉角的几何表示。
  
  欧拉角在不同领域的约定没有共识。
  因此，具体使用需要指定。
  本文定义并验证了常用的欧拉角约定。
  
  * 6.1 符合xyz约定的欧拉角
	由xyz约定的角度称为Tait-Bryan角，经常出现在描述移动交通工具或导弹的方向的工程应用中。
	反映了绕机体轴旋转的roll，绕垂直与机体轴旋转的pitch，绕垂直轴的yaw。
	图6中，绕三个轴的旋转分别称为 roll(psi), pitch (theta) 和 yaw (phi)
	【符号不太对，roll是phi，yaw是psi】
	
	由公式11，roll-pitch-yaw的旋转矩阵由如下公式给出
	[13] BAG_rpy = A(z,phi) * A(y,theta) * A(x,psi)
	【这里并没有说明为什么要这样做】
	
	按照roll,pitch,yaw的物理含义，提供了如下定义：
	BAG_rpy = ...
	接着，证明了 BAG_rpy 的等价性，一般 roll-pitch-yaw 序列能别转换到旋转矩阵。
	
	引理13：公式[13]的形式验证
	BAG_rpy = [[cos*cos;...];...]
  * 6.2 符合 zxz约定的欧拉角
    按照zxz惯例，
		precession(进动,旋进)是绕z轴的旋转 phi，
		nutation(章动)是绕x轴的旋转 psi，
		spin(自旋)是绕z的另一个旋转 alpha。
	其旋转矩阵由如下公式给出。
	[14] Euler_zxz = A(z,phi) * A(x,psi) * A(z,alpha)
	对反映欧拉角的旋转矩阵的形式化证明如下
	引理14：公式[14]的形式验证
		Euler_zxz = [[...]..]
	
	基于precession角alpha, nutation角psi，rotation角phi，可以计算整个旋转矩阵。
	给定一个旋转矩阵，可以恢复欧拉角。
	
	如下公式给出了 precession角alpha的算法
	[15], -pi <= alpha <-pi/2,    alpha = -atan(r31/r32) - pi
		  -pi/2 <= alpha < pi/2,  alpha = -atan(r31/r32)
		  pi/2 <= alpha < pi,     alpha = -atan(r31/r32) + pi
    【有个疑问，如何知道它的范围？】
	使用引理15-18表示alpha在1到4象限的验证
	
	引理15：在 [0,pi/2)，alpha = -atan(r31/r32).  【只是对定义的改写，并没有证明 Euler_zxz 与 角度的关系】
	引理16：类似
	引理17：类似
	引理18：类似
	
	以下公式给出了 nutation角 psi 的算法
	[16]  [-pi,0), psi  = -arccos(r33)
		  [0,pi),   psi = arccos(r33)
    对psi的解法的形式验证如下：
	引理19：[0,pi), psi = arccos(r33).  【只是定义的改写，没有态度验证价值】
	引理20：类似
	
	最后，对rotation角phi的解法如下
	[17]  [-pi,-pi/2),   phi = atan(r13/r23)-pi
		  [-pi/2,pi/2), 
		  [pi/2, pi),
    相应的验证如下：
	引理21：[0,pi/2), phi = atan(r13/r23)
	引理22：类似
	引理23：类似
	引理24：类似

# 7. Rodriguez公式
  有固定点O的刚体，绕G中的向量xi旋转phi，可以被分解绕三个特定不共面的轴的旋转。
  另一方面，当一个刚体旋转了有限多次后，它的旋转效果等价于绕一个特定轴的旋转。
  Rodriguez公式是一个简单而高效的方式来描述这样的旋转。
  * 7.1 Rodriguez公式的存在性的证明
	过G中O点的一条直线xi'，刚体绕xi'旋转了phi。
	将xi的方向向量表示为u。
	刚体绕u的旋转等价于以下过程：
	(1) 绕B的一个轴旋转以便与u重合；
	(2) B绕u旋转phi
	(3) B执行一个步骤(1)的反向的旋转。

    如图7所示，我们旋转B中的z轴来与u重合。
	在图中，刚体首先绕z轴旋转theta；然后绕y旋转phi，使得z轴与u重合；
	然后，它绕z旋转phi；最后是反向顺序的旋转。
	对应的旋转如下所示：
	[18] GRB = ((Az(-phi)) * (Az(-theta)) * (Az phi) * (Ay theta) * (Az phi))\T

	根据公式[18]，假设 GRB的等价性，并在约束下求解GRB的矩阵形式。
	
	有了这个推论，我们假设z轴在旋转两次后与u重合。
	使用如下形式化来验证这个假设。
	引理25：存在角度phi和theta，使得z轴的向量 [0 0 1]在两次旋转后，与G中的u重合
	
	引理26：公式[18]的形式验证
	GRB = [[...];...]
	【这里的定义是怎么来的？没有证明】
	
  * 7.2 Rodriguez公式的定义
	在引理25中，已证明，过原点的任意旋转轴u，总能在两次旋转后转到z轴。
	在引理26中，验证了在约束下的等价的旋转矩阵GRB。
	使用引理26，Rodriguez公式可以按如下公式来推导。
	[19] u = [u1 u2 u3]\T, u\hat = skew(u),
		 R(u,phi) = GRB = I * cos phi + (1 - cos phi) * u * u\T + (sin phi) * u\hat

    一般的，任意非零向量xi，其单位向量是 e_u = xi / |xi|。
	按照公式[19]，定义Rodriguez公式为 ELR。
	【这里，将斜对称矩阵命名为 tilde 】
	
  * 7.3 Rodriguez公式与绕RAG的一个旋转的等价
	Rodriguez公式适用于绕G中向量xi的旋转。
	当xi与X/Y/Z轴重合时，ELR等价于绕RAG的旋转矩阵Q。
	
	引理27：xi=[x,0,0], u = xi/|xi|, R(u,phi) = QX phi
	引理28：类似
	引理29：类似
	【这几个验证也是有意义的，尽管实际的旋转并不是绕这三个轴，而是多次旋转的复合】
	
  * 7.4 旋转轴和角的不唯一性。
	使用ELR，可以获得给定旋转角phi和轴xi的对应的旋转矩阵GRB。
	反之，给定GRB，可以获得phi和u（指xi的单位向量）。
	由公式[20]给出，
	[20]  u\hat = ..
		  sin phi = ..,  cos phi = ..
    根据公式20，给定GRB时，phi和xi的解答不唯一。
	使用如下两个引理来验证解答不唯一性。
	
	引理30：当xi是任意非零向量，u=xi/|xi|，R(u,phi)=R(-u,-phi)
	引理31：当xi是任意非零向量，u=xi/|xi|，R(u,phi)=R(u,phi+2*pi)
	
  * 7.5 Rodriguez公式的一般化
	对Rodriguez公式的形式验证假定了B和G初始时是一致的。
	也就是，初始状态，r在G和B中是等价的。
	更一般的，B和G不需要初始时一致，如下公式所示
	[21] B_r = BRG' * G_r
	
	当初始状态的坐标系不一致时，为了得到Rodriguez公式，假定一个新的全局坐标系G0，初始时与B一致。
	于是，r从B到G的转换会分解为 B到G0 和 G0到G。
	
	为了得到B到G0的旋转矩阵，使用Rodriguez公式。公式如下：
	[22] 0RB = ...
	
	然后B到G的旋转矩阵是如下公式给出的最终状态。
	[23] GRB = .. = R(u,phi) * GR0
	
	形式化的验证公式[23]。
	首先，定义旋转轴u，旋转角phi，旋转矩阵 _0RG，给定单位向量u
	然后，根据引理11，定义旋转矩阵GR0。
	再次，按照公式[22]，重新定义旋转轴 
		_0u = 0RG * u
		_0RB = ELR phi _0u
	最后，为 B -> G0 -> G 定义旋转矩阵GRB。
		GRB = GR0 * _0RB
	基于这些定义，公式[23]的等价关系的形式验证如下
	
	引理32：验证公式[23]。GRB = ELR phi u * GR0

# 8. 案例分析和验证
  本节，我们分析了证明了几个与机器人旋转有关的案例，展示我们对所设计机器人的形式验证的适用性。
  * 8.1 绕全局坐标系的旋转
	案例1：初始状态，G和B重合，以B表示的刚体D，随着刚体D中的点 PB=[10,20,30]]\T，
	以 0.6 pi rad/s 的角速度连续绕G的X轴旋转。
	计算P_B在G中的位置P_G，在t=5s时
	Example eg1 : Br = [10;20;30] -> t = 5 -> omega t theta = 0.6*pi -> axis=X -> 
	G_r = [-10;20;-30]
	本例中，用非形式化的方式获得答案P_G=[-10;20;-30]\T。
	形式化的，使用上面的形式验证。
	
  * 8.2 绕局部的旋转
	案例2：初始装填，G和B重合，以G表示的刚体D，首先以pi/4绕z轴旋转，
	然后以pi/4绕x轴，最后以pi/4绕y轴，沿着刚体D上的点P_G=[10,20,30]。
	用P_B来表示在B中的P_G旋转后的值。
	Example eg2: CRB [(z,pi/4); (x,pi/4); (y,pi/4)] [10,20,30]\T = 
		[5*sqrt2/2; 5+15*sqrt2; 30-5*sqrt2/2]
  
  * 8.3 欧拉角案例
	案例3：给定precession角alpha=pi/4，nutation角phi=pi/4, rotation角phi=pi/4,
	给出对应于这个欧拉角的旋转矩阵
	Example eg3: alpha=pi/4 -> psi=pi/4 -> phi=pi/4 ->
		Euler_zxz alpha psi phi = [[..]..]
	
	案例4：给该的那个旋转矩阵如下，计算对应的欧拉角
	[24] Euler_zxz = [[..]..]
	Example eg4: Euler_zxz = [[..]..] -> alpha = pi/4 /\ ..
	
  * 8.4 Rodriguez公式
	案例5：局部坐标系B绕三个欧拉角(pi/4,pi/4,pi/4)关于全局坐标系G旋转，
	计算旋转轴u和旋转角phi
	Example eg5: theta1=pi/4 -> theta2=pi/4 -> theta3=pi/4 -> BRG = Euler theta1 theta2 theta3 ->
		u = xxx \/ u = - xxx
	【这里只是公式的应用，也没有 phi 的计算】
	
	案例6：刚体绕X中U轴旋转pi/6，假定刚体绕u=[sqrt3/3, sqrt3/3, sqrt3/3] 连续旋转 phi=pi/2。
		计算对应的旋转矩阵 GRB
	Example eg6: GRB = [[..]..]

# 9. 总结
  运动控制系统中的最基本的理论之一，旋转运动学广泛用于不同的研究主题。
  本文，使用形式化技术验证了机器人旋转运动理论的正确性。
  将旋转运动分为两类：revolution和rotation，并形式化的定义了它们。【这部分是重点】
  特别的，在Coq中建立了3D坐标系模型，并形式化的定义了矩阵的trace，F范数，内积。
  我们形式化了欧拉角的定义，并验证了与旋转矩阵的变换关系。
  而且，完成了Rodriguez公式的机械化证明。【实际上，可能没有完成】
  本文，所有证明和验证都在Coq中完成。
  所有源代码都在 github 上可访问。
  
  总体上，形式验证的证明包含了3200行代码。
  代码已经被测试，并且应该可在Coq8.13.2编译。
  表1提供了额脚本文件的各项统计。
  为了帮助在它们之间导航，这里加了对应本文的各节的索引。
  并且将规范和证明的行数分开了。
  
  将来，我们会完成耕读哦机器人控制技术的验证，基于本文的形式验证框架。
  更多复杂运动学逻辑，我们会提高更多类型机器人运动学的形式验证框架。
  我们的目标是完成一个机器人控制系统的形式验证。
  我们也计划开发一些自动策略来提高形式证明的自动化。
  这将是一个有意义的探索，值得在自动控制验证领域尝试。
  此外，我们将会尝试结合带代码生成技术和形式验证。
  我们计划使用Coq证明助手来设计一个机器人控制算法并自动生成C代码。
  期望极大的提高机器人控制系统的安全保障。
  
	
	
	
	
	
	
	
  
	  
	  
	  
	  
  
	  
	  
	  
	  
	  
	  
  
	
	
  
  
  
