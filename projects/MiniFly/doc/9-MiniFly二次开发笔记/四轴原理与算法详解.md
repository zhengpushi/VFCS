
# 硬件资源

* 主控MCU接口
  主控STM32F411CEU6
  任务：读取传感器数据，数据融合，PID控制，电机控制，无线通信，USB通信等。
* 传感器接口
  * 九轴MPU9250（内含3轴加速度计，3轴陀螺仪，3轴磁力计）
	用于测量四轴的姿态数据
  * 气压传感器BMP280
	支持温度和气压测量，温度分辨率0.01摄氏度
  * 通信接口
	使用IIC（使用模拟IIC，并未采用硬件IIC）。
* 电机接口
  电机是716空心杯电机，驱动是NMOS管SI2302。
* 无线通信和PA接口
  无线通信芯片NRF51822，功率放大芯片RFX2401C，平衡滤波器芯片2450BM15A002。
  确保空旷环境下，飞行器和遥控器的通信距离大于100米。
* 电源接口
  充电芯片TP4059，使用USB接口即可充电。
  低压差线性稳压器（LDO）XC6204B302，同时为NRF和主控供电。
* LED接口
  2颗红绿双色LED，2颗蓝色LED。
* 扩展接口
* 下载接口
  板载SWD接口，可分别为两侧下载程序。

# 四轴飞行器算法讲解
* 姿态解算
  定义：读取传感器数据，计算飞行器姿态角，计算电机输出量，使飞行器保持设定的姿态飞行。
  备注：是飞行器飞行的关键技术之一，解算速度和精度关系到飞行器飞行中的稳定性和可靠性。
  方法：
  * 扩展型卡尔曼滤波(EKF)：高精度，但计算量大，要求建立精确的动力学模型，并不是微型四轴的最佳选择。
  * 互补滤波：对系统要求较低，计算量不大，在微型四轴中应用最广。
  
* 飞行器姿态表示方法
  * 欧拉角
	使用前必须给定定义。
  * 四元数
	单位四元数与欧拉角、旋转矩阵是等价的，但不同于欧拉角表示，四元数表示法没有奇异点的问题。
	另外，四元数能方便的给出旋转的转轴和旋转角。
	
* 软件姿态解算
  
  首先可以利用三次旋转得到一个表示旋转的方向余弦矩阵。
  $$
  C_n^b=C_2^bC_1^2C_n^1
  $$
  若想用欧拉角解算姿态，可使用欧拉角微分方程：
  $$
  \begin{bmatrix}\dot{\gamma}\\\dot{\theta}\\\dot{\psi}\end{bmatrix}=
  \frac{1}{\cos\theta}
  \begin{bmatrix}
  \cos\theta & \sin\gamma\sin\theta & \cos\gamma\sin\theta \\
  0 & \cos\theta\cos\gamma & -\sin\gamma\cos\theta \\
  0 & \sin\gamma & \cos\gamma\cos\theta
  \end{bmatrix}
  \cdot
  \begin{bmatrix}\omega_X^b\\\omega_Y^b\\\omega_Z^b\end{bmatrix}
  $$
  该微分方程在当三个欧拉角的变化很小时成立，而这个很小的变化恰好可以使用传感器来测量。
  其中，右侧的角度是上个周期测算出来的角度，即，使用三周陀螺仪测量这个周期转动的角度。
  比如，在T=0.02秒（50Hz）的周期内，陀螺仪角速度是0.01弧度/秒，则得到角度是0.0002弧度。
  然后求解这个微分方程来解算当前的欧拉角。
  为何不使用欧拉角来表示旋转呢？1. 欧拉角微分方程中含有大量三角运算，为实时解算带来困难；2. 当俯仰角为90度时方程式有GimbalLock。所以欧拉角方法只适用于水平姿态变换不大的情况，不适用于全姿态飞行器的姿态确定。
  
  而四元数法只求解四个未知量的线性微分方程组，计算量小，是比较实用的工程方法。
  刚才用欧拉角描述的方向余弦矩阵可用四元数描述为：
  $$
  C_n^b=C(q_0,q_1,q_2,q_3)
  $$
  该公式，即，从单位四元数转换为旋转矩阵。

* PID控制理论
  当今的闭环自动控制技术都是基于反馈的概念以减少不确定性。
  PID控制器是一个在工业控制应用中常见的反馈回路部件：
  * 基础是比例控制
  * 积分控制可消除稳态误差，但可能增加超调
  * 微分控制可加快大惯性系统响应速度以及减弱超调趋势
  这个理论和应用的关键是：在得到正确的测量和比较后，如何更好地纠正系统。
  PID已有近百年历史，现在仍然是应用最广泛的工业控制器。
  PID控制器简单易懂，不需要精确的系统模型等先决条件。
  分析各个部分：
  * P
	控制器的输出与输入误差信号成比例关系。
	当仅有比例控制时，系统输出存在稳态误差。
	比例项输出：$P_{out} = K_p e(t)$
  * I
	控制器的输出与输入误差信号的积分成正比关系。
	积分项是误差对时间的积分，这样即便误差很小，积分项也会逐渐加大，然后它会推动控制器的输出增大使稳态误差进一步减小，直到等于零。
	所以比例积分（PI）控制器，可使系统在进入稳态后无稳态误差。
	积分项输出：$I_{out} = K_i \int_0^t e(\tau)d_{\tau}$
  * D
	控制器的输出与输入误差信号的微分成正比关系。
	微分调节是偏差值的变化率，使用微分控制能够实现系统的超前控制。
	如果输入偏差值线性变化，则可以在调节器输出侧叠加一个恒定的调节量。
	大部分控制系统不需要调节微分时间。
	微分输出项：$D_{out} = K_d \frac{d}{dt}e(t)$。
  当将PID三项相加，即可得到PID控制的数学表达式。

* 四轴常用的2种PID
  * 单级PID
	
  * 串级PID
