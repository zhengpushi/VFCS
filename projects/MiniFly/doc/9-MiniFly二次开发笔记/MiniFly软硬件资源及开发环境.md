# MiniFly软硬件资源及开发环境

## 0. 术语

* STM32：意法半导体公司的一个产品系列
* Cortex-M：ARM公司的一个单片机系列，包括Cortex-A, Cortex-M, Cortex-R，面向不同场合。
* Cortex-M0, Cortex-M3, Cortex-M4: 本文所涉及到的ARM芯片系列的代号，M4性能最高。
* PWM: Pulse Width Modulation 脉冲宽度调制，通过控制方波信号的占空比来模拟需要的输出信号的一种技术。
* ESC: 电子调速器，用PWM技术将数字信号转化为电压信号并驱动电机
* 电池放电倍率：表示电池放电能力。比如250mAh容量的电池，倍率为20C，则最大放电电流是20*250mA=5A。若以5A的电流持续放电，则3分钟会用完电量。若以250mA电流放电，则1小时。
* MCU: Microcontroller Uinit 微控制单元、单片机。包含有CPU、ROM、RAM、IO口、Timer、中断控制器、各种外设等的单一芯片级计算机。MCU的存储器类型有多种，有一次性的，和多次可擦写的，常见的是Flash ROM。
* Flash Memory：闪存。单片机中的程序存储于此，利用内置缓存机制和XIP的支持，代码就在这里运行，不需要搬运到RAM。
* 无线通信：本文特指2.4GHz频段的通信，在协议上使用Nordic公司的专用格式，这个不是重点。
* UART：Universal Asynchronous Receiver/Transmitter 通用异步收发器，是一种串行通信收发协议，也是串行通信接口的代名词。

## 1. MiniFly硬件资源

* 四轴飞行器的基本组成

  * 电机：空心杯有刷电机
  * 电调：MOS管
  * 电池：250mAh 20C 1S锂电池
  * 桨叶：直径为46mm的桨叶
  * 机架：PCB支架
  * 遥控器：美国手方式（油门摇杆在左、方向摇杆在右），至少四通道控制动作路数（上下、左右、前后、旋转）
  * 飞控：核心部件，由MCU、陀螺仪、加速度计、磁力计、气压计、无线接收模块等组成。
* 微型四轴硬件资源
  * 双MCU机制，主控和辅控，二者以UART通信。
  * 主控MCU：STM32F411CEU6
    * 资源：Cortex-M4, 96MHz, 512KB Flash, 128KB RAM, 3个16位定时器, 2个32位定时器, 2个DMA控制器, 5个SPI(全双工I2S), 3个IIC, 2个UART, 1个USB (支持HOST/SLAVE), 16通道12位ADC, 36个IO口等。

    * 任务：读取传感器数据、数据融合、PID控制、电机控制、无线通信和USB通信等。
  * 辅控MCU：NRF51822
    * 资源：Cortex-M0, 16MHz, 256KB Flash, 16KB RAM, BLE&NRF radio。

    * 它支持蓝牙低功耗协议，以及一系列专有的2.4GHz协议，比如Nordic半导体公司的Gazell协议，简称NRF协议。

    * 负责无线通信、电源管理。
  * 传感器接口
    * 九轴传感器MPU9250
      * 资源：3轴加速度计、3轴陀螺仪、3轴磁力计，自带DMP(Digital Motion Processor), 支持MPL（Motion Processing Library）。MPL是Invensense专利的算法库，不开源，作用是传感器融合和动态标定。

      * 任务：测量四轴的姿态数据。

      * 注意事项：
        * MPU9250的MPL，上电默认是6轴，必须磁场画8校准后，才能进入9轴模式。
    * 高精度气压传感器BMP280
* 遥控器硬件资源

## 2. MiniFly固件（软件）资源

* 飞控主控
  * Bootloader
    * 裸机程序
    * USB通信、升级、跳转
  * App
    * FreeRTOS
    * 主要的通信线程
      * UART2与NRF通信，读取串口数据，并放入缓存区
      * 解析任务：根据下行指令ID来执行不同任务，主要负责解析数据、校准、传递PID参数等
      * 发送任务：定期向NRF和USB发出相同的数据包，包括状态、控制等。
        * 同时向NRF和USB发出相同的数据包
        * 间隔30ms，发送状态（欧拉角、气压、等）
        * 间隔10ms，发送传感器（9轴）
        * 间隔40ms，发送RCData（无线电控制信号，油门、三个欧拉角，多个0）
        * 间隔100ms，发送电量（电池电压、电流是假的）
        * 间隔40ms，发送电机控制值（电机占空比从0~65535再转换到0~1000。
        * 间隔40ms，发送传感器2（气压计）
        * 间隔50ms，发送速度（暂没有使用）
        * 间隔20ms，发送用户数据（第一组：加速度、速度、位置；第二组：光流等）
    * 主要的处理线程
      * 传感器采集
        * 二阶低通滤波 lpf2 (Low-Pass Filter )
        * IIR滤波
      * 姿态处理
        * 四元数、欧拉角计算
        * 位置预估
        * 目标设定
        * 高度控制
        * PID控制
        * 控制电机输出：由四个值决定（油门、欧拉角三分量）
* 飞控无线通信固件
  * App
    * 裸机程序
    * 按键、电源、无线数据发送、UART串口发送给STM32F4
* 遥控器固件
  * Bootloader
  * App

## 3. 开发环境

* Keil MDK 5.21A
  * 编辑、烧录、在线调试
* Segger J-Link driver 5.12g
  * 烧录、调试支持
